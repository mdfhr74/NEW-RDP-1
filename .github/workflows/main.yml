name: Windows RDP via Pinggy.io

on: [push, workflow_dispatch]

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Set RDP Password
      run: |
        net user runneradmin "P@ssw0rd!"

    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Download Pinggy
      run: |
        Invoke-WebRequest -Uri "https://github.com/pinggy-io/pinggy/releases/download/v0.6.0/pinggy-windows-amd64.exe" -OutFile pinggy.exe

    - name: Start Pinggy Tunnel (TCP 3389)
      run: Start-Process -NoNewWindow -FilePath ".\pinggy.exe" -ArgumentList "--tcp 3389" -RedirectStandardOutput pinggy.log

    - name: Wait and Show RDP Address
      run: |
        Start-Sleep -Seconds 15
        Get-Content pinggy.log | Select-String "tcp://" | Set-Content rdp_address.txt
        Write-Output "`nüîó Your RDP Address:"
        Get-Content rdp_address.txt

    - name: Prevent Idle Timeout
      run: |
        for ($i = 0; $i -lt 720; $i++) {
          Write-Output "‚è≥ Running... $i"
          Start-Sleep -Seconds 30
        }
